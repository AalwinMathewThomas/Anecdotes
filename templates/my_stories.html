{% extends "base.html" %}
{% block title %}My Stories{% endblock %}
{% block content %}
    <div class="container">
        <h2>My Stories</h2>
        <form class="mb-4" method="GET" action="{{ url_for('auth.my_stories') }}">
            <div class="input-group">
                <input type="text" class="form-control" name="search" placeholder="Search my stories..." value="{{ search_query or '' }}">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
        <div class="row">
            {% for story in stories %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ story.title }}</h5>
                            <p class="card-text">Visibility: {{ 'Public' if story.is_public else 'Private' }}</p>
                            <p class="card-text">{{ story.likes | length }} {{ 'Like' if story.likes | length == 1 else 'Likes' }}</p>
                            {% if username %}
                                <form method="POST" action="{{ url_for('auth.like_story', story_id=story.id) }}" style="display:inline;">
                                    <button type="submit" class="btn btn-{{ 'danger' if story.id in liked_ids else 'outline-primary' }} btn-sm me-2">
                                        <i class="bi {{ 'bi-heart-fill' if story.id in liked_ids else 'bi-heart' }}"></i>
                                        {{ 'Unlike' if story.id in liked_ids else 'Like' }}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('auth.favorite_story', story_id=story.id, page=page, search=search_query) }}" style="display:inline;" class="favorite-form" data-story-id="{{ story.id }}">
                                    <button type="submit" class="btn btn-{{ 'danger' if story.id in favorite_ids else 'success' }} btn-sm me-2 favorite-btn">
                                        {{ 'Unfavorite' if story.id in favorite_ids else 'Favorite' }}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('auth.delete_story', story_id=story.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this story?');">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            {% else %}
                                <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm me-2">Log in to like</a>
                                <a href="{{ url_for('auth.login') }}" class="btn btn-success btn-sm me-2">Log in to favorite</a>
                            {% endif %}
                            <a href="{{ url_for('auth.story', story_id=story.id) }}" class="btn btn-primary btn-sm">Read</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <p>No stories found.</p>
            {% endfor %}
        </div>
        <div class="mt-4">
            {% if prev_page %}
                <a href="{{ url_for('auth.my_stories', page=page-1, search=search_query) }}" class="btn btn-outline-secondary me-2">Previous</a>
            {% endif %}
            {% if next_page %}
                <a href="{{ url_for('auth.my_stories', page=page+1, search=search_query) }}" class="btn btn-outline-secondary">Next</a>
            {% endif %}
        </div>
    </div>
    {% if username %}
    <script>
        document.querySelectorAll('.favorite-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const storyId = form.dataset.storyId;
                const btn = form.querySelector('.favorite-btn');
                const isFavorited = btn.classList.contains('btn-danger');
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                    });
                    if (response.ok) {
                        if (isFavorited) {
                            btn.classList.remove('btn-danger');
                            btn.classList.add('btn-success');
                            btn.textContent = 'Favorite';
                        } else {
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-danger');
                            btn.textContent = 'Unfavorite';
                        }
                    } else {
                        alert('Error toggling favorite status.');
                    }
                } catch (error) {
                    alert('Network error: ' + error.message);
                }
            });
        });
    </script>
    {% endif %}
{% endblock %}